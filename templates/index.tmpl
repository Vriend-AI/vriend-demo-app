<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo App | Vriend</title>
    <style>
      .hidden { display: none; }
      .container { text-align: center; margin-top: 50px; }
      .api-response {
        padding: 20px; color: #fff; background: #222;
        text-align: left; border-radius: 4px; margin-top: 20px;
      }
      .btn {
        padding: 8px 16px; margin-top: 20px; border: none;
        border-radius: 4px; cursor: pointer; font-size: 1rem;
        transition: background 0.2s;
      }
      .btn-logout { background: #dc3545; color: white; }
      .btn-logout:hover { background: #c82333; }
      .signin-btn {
        display: inline-flex; align-items: center; gap: 8px;
        background: linear-gradient(90deg, #300047 0%, #400047 100%);
        color: #fff; font-weight: 600; font-size: 1rem; padding: 7px 12px;
        border-radius: 4px; box-shadow: 0 2px 8px rgba(46, 143, 255, 0.15);
        text-decoration: none; transition: background 0.2s, box-shadow 0.2s;
        min-width: 240px; max-width: 100%;
      }
      .signin-btn:hover { background: linear-gradient(90deg, #100047 0%, #200047 100%); }
      .signin-btn img {
        width: 32px; height: 32px; background: none; border-radius: 50%;
        padding: 0; display: block; object-fit: contain; flex-shrink: 0;
      }
      .signin-btn span { white-space: nowrap; }
      .title { font-size: 2rem; color: #333; margin-bottom: 16px; }
      .subtitle { font-size: 1.2rem; color: #666; margin-bottom: 24px; }
      .divider { margin: 20px 0; border: 0; border-top: 1px solid #ccc; }
      .spinner {
        border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
        border-radius: 50%; width: 40px; height: 40px;
        animation: spin 2s linear infinite; margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Alpine.js cloak - prevents flash of unstyled content */
      [x-cloak] {
        display: none !important;
      }

      /* Hide Alpine.js controlled content until it's ready */
      .alpine-content {
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }

      /* Show content when Alpine.js is ready */
      .alpine-ready .alpine-content {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <!-- Alpine.js App with proper cloak handling -->
    <div id="app" x-data="authApp()" x-init="init(); $nextTick(() => document.body.classList.add('alpine-ready'))" class="alpine-content" x-cloak>
      
      <!-- Loading State -->
      <div x-show="isLoading" class="container">
        <div class="spinner"></div>
        <p>Checking authentication...</p>
      </div>

      <!-- Login Screen -->
      <div x-show="!isAuthenticated && !isLoading" class="container">
        <h1 class="title">Welcome to the Demo App</h1>
        <p class="subtitle">Please sign in to continue.</p>
        <p>
          <a :href="loginURL" class="signin-btn" rel="noopener">
            <img
              src="https://cdn.vriend.ai/images/vriend-icon-white.png"
              alt="Vriend Inc. Icon"
              @error="$event.target.style.display='none'"
            />
            <span>
              Sign in with
              <em style="font-style: normal; font-weight: 800">Vriend ID</em>
            </span>
          </a>
        </p>
      </div>

      <hr class="divider" />

      <!-- Authenticated Screen -->
      <div x-show="isAuthenticated && !isLoading" class="container">
        <h1 class="title">Welcome, you are logged in!</h1>
        <p class="subtitle">You now have access to protected resources.</p>
        <button class="btn btn-logout" @click="logout()">
          Logout
        </button>
        <pre x-show="userInfo" class="api-response" x-text="'API response:\n' + JSON.stringify(userInfo, null, 2)"></pre>
        <pre x-show="apiError" class="api-response" x-text="'API error: ' + apiError"></pre>
      </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="//unpkg.com/alpinejs" defer></script>

    <script>
      // Alpine.js app data and methods
      function authApp() {
        return {
          // State
          isAuthenticated: false,
          isLoading: true,
          userInfo: null,
          apiError: null,
          loginURL: "{{ .LoginURL }}",

          // API clients
          vriendAPI: axios.create({
            baseURL: "{{ .VriendAPIURL }}",
            headers: { "Content-Type": "application/json" },
            withCredentials: true,
          }),

          localAPI: axios.create({
            baseURL: window.location.origin,
            withCredentials: true,
          }),

          // Methods
          async init() {
            await this.checkAuthStatus();
          },

          async checkAuthStatus() {
            try {
              this.isLoading = true;
              this.apiError = null;
              
              const response = await this.vriendAPI.get("/info");
              
              this.userInfo = response.data;
              this.isAuthenticated = true;
            } catch (error) {
              this.isAuthenticated = false;
              this.userInfo = null;
              this.apiError = error.message || 'Authentication failed';
            } finally {
              this.isLoading = false;
            }
          },

          async logout() {
            try {
              await this.localAPI.get("/logout");
            } catch (error) {
              console.error('Logout error:', error);
            } finally {
              // Always reset auth state
              this.isAuthenticated = false;
              this.userInfo = null;
              this.apiError = null;
            }
          }
        }
      }
    </script>
  </body>
</html>
